P221

弱隔离级别：不存在数据依赖关系，可并行执行。

数据库不愿意牺牲性能，倾向于采用弱隔离级别，会造成大量资金损失。

读-提交：读数据库，只看到已成功提交的数据。写数据库，覆盖已成功提交的数据。防止脏读、脏写。

脏读：某个事务完成部分数据写入，但事务未提交，另一个事务若能够看到未提交的数据，即为脏读。

先前的写入尚未提交，若被覆盖即为脏写。通常用行级锁防止脏写。一直持有锁到事务提交。只有一个事务能拿到锁。

防止脏读，试图读取该对象的事务必须申请锁，事务完成之后释放锁。

读锁的方式在实际中不可行，会严重影响只读事务的响应延迟，可操作性差。大多采用：对每个待更新的对象，数据库维护旧值和新值两个版本。事务提交之前，都读取旧值。写事务提交后，才可读取新值。

快照级别隔离与可重复读

读倾斜与不可重复读。通过快照级别隔离来解决，保证事务看到的是该特定时间点的旧数据。写锁来防止脏写，读取不需枷锁。读操作不会阻止写操作。

一致性快照的可见性规则

事务开始时，列出所有尚在进行的事务，忽略完成的部分写入。

中止事务所做的修改全部不可见。

即晚于当前事务所做的任何修改不可见。

其他所有的写入都对应用查询可见。

索引与快照级别隔离

索引直接指向对象的所有版本

写时复制的技术

防止更新丢失

写事务并发会带来更新丢失问题。 原子写操作。
